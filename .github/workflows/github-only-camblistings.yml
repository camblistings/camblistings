name: Deploy to GitHub Pages Only

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger
  repository_dispatch:
    types: [sync-request]  # Trigger from private repo

jobs:
  deploy-github:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout camblistings repo
        uses: actions/checkout@v4
        with:
          repository: camblistings/listings-data
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright beautifulsoup4 requests

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Sync latest data from hohum
        run: |
          # Get latest data from private hohum repo
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/simonjhowarth/hohum/contents/website_data_by_cinema.json \
               | jq -r '.content' | base64 -d > website_data_by_cinema.json

      - name: Validate data
        run: |
          python3 validate_cinema_data.py

      - name: Commit updated data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add website_data_by_cinema.json
          if git diff --staged --quiet; then
            git commit -m "ðŸŽ¬ Update cinema data - $(date '+%Y-%m-%d %H:%M')"
            git push
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Build static site
        run: |
          # Create index.html from your existing file
          cp index_v2.html index.html
          # Update data URL in HTML to point to this repo
          sed -i 's|const dataUrl = .*|const dataUrl = '\''website_data_by_cinema.json'\'';|' index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: './'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
